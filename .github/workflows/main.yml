name: Auto Build VLCKit Universal

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0ç‚¹æ£€æŸ¥ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

# ðŸ‘‡ ä¿®å¤é‡ç‚¹ 1ï¼šå¿…é¡»æ˜¾å¼èµ‹äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•å‘å¸ƒ Release å’Œæäº¤ä»£ç 
permissions:
  contents: write
  issues: write

env:
  UPSTREAM_REPO: 'videolan/vlckit'
  KEEP_RELEASES: 3  # åªä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬

jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
  check-update:
    name: Check for New Tags
    runs-on: ubuntu-latest
    outputs:
      has_new_tag: ${{ steps.check.outputs.has_new_tag }}
      new_tag: ${{ steps.check.outputs.new_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check upstream
        id: check
        run: |
          # èŽ·å–ä¸Šæ¸¸ VLC ä»“åº“çš„æœ€æ–° Tag
          # é€»è¾‘ï¼šèŽ·å–è¿œç¨‹ tags -> æŽ’é™¤ ref^{} -> ç‰ˆæœ¬å·æŽ’åº -> å–æœ€åŽä¸€ä¸ª -> åŽ»æŽ‰ refs/tags/ å‰ç¼€
          LATEST_TAG=$(git ls-remote --tags --refs https://github.com/${{ env.UPSTREAM_REPO }}.git | \
            grep -v '\^{}' | sort -t '/' -k 3 -V | tail -n1 | \
            awk '{print $2}' | sed 's|refs/tags/||')
          
          echo "ðŸ“¡ ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"

          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²ç»æ‰“è¿‡è¿™ä¸ª Tag
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "âœ… æœ¬åœ°å·²å­˜åœ¨ Tag $LATEST_TAGï¼Œæ— éœ€æž„å»ºã€‚"
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸš€ å‘çŽ°æ–°ç‰ˆæœ¬: $LATEST_TAGï¼Œå‡†å¤‡å¼€å§‹æž„å»ºæµç¨‹..."
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒæ­¥ï¼šç¼–è¯‘ã€æ‰“åŒ…ã€æ›´æ–° SPM é…ç½®ã€å‘å¸ƒ
  build-and-release:
    name: Build & Publish
    needs: check-update
    if: needs.check-update.outputs.has_new_tag == 'true'
    # ðŸ‘‡ ä¼˜åŒ–ï¼šä½¿ç”¨ macos-14 (Apple Silicon) ç¼–è¯‘é€Ÿåº¦æ›´å¿«
    runs-on: macos-14
    timeout-minutes: 360 # 6å°æ—¶è¶…æ—¶é™åˆ¶
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»æ‹‰å–å®Œæ•´åŽ†å²ï¼Œå¦åˆ™æ— æ³•æäº¤ä»£ç 
          token: ${{ secrets.GITHUB_TOKEN }}

      # å®‰è£…ç¼–è¯‘ä¾èµ–
      - name: Install Dependencies
        run: |
          echo "ðŸ”§ å®‰è£…æž„å»ºå·¥å…·..."
          brew install automake libtool pkg-config cmake ant nasm meson ninja

      # å…‹éš† VLCKit æºç 
      - name: Clone VLCKit Source
        run: |
          echo "ðŸ“¥ å…‹éš†ç‰ˆæœ¬: ${{ needs.check-update.outputs.new_tag }}"
          git clone --depth 1 --branch ${{ needs.check-update.outputs.new_tag }} \
            https://github.com/${{ env.UPSTREAM_REPO }}.git vlckit-src

      # å¼€å§‹ç¼–è¯‘
      - name: Build Universal XCFramework
        run: |
          cd vlckit-src
          echo "ðŸ—ï¸ å¼€å§‹ç¼–è¯‘ (è¿™å¯èƒ½éœ€è¦ 1-2 å°æ—¶)..."
          
          # è¿è¡Œå®˜æ–¹ç¼–è¯‘è„šæœ¬
          # -f: framework
          # -r: release mode
          # -a all: æ‰€æœ‰æž¶æž„
          # -v: è¯¦ç»†æ—¥å¿—
          ./compileAndBuildVLCKit.sh -f -r -a all -v
          
          # éªŒè¯äº§ç‰©æ˜¯å¦å­˜åœ¨
          if [ ! -d "build/VLCKit.xcframework" ]; then
             echo "âŒ è‡´å‘½é”™è¯¯ï¼šç¼–è¯‘å®ŒæˆåŽæœªæ‰¾åˆ° XCFrameworkï¼"
             exit 1
          fi
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"

      # åŽ‹ç¼©å¹¶è®¡ç®—å“ˆå¸Œå€¼
      - name: Compress & Checksum
        id: package
        run: |
          # å°†äº§ç‰©ç§»åˆ°å·¥ä½œåŒºæ ¹ç›®å½•
          mv vlckit-src/build/VLCKit.xcframework ./VLCKit.xcframework
          
          echo "ðŸ“¦ æ­£åœ¨åŽ‹ç¼© (-9 æœ€é«˜åŽ‹ç¼©çŽ‡)..."
          zip -9 -r VLCKit.xcframework.zip VLCKit.xcframework
          
          echo "ðŸ§® è®¡ç®— SHA256..."
          CHECKSUM=$(shasum -a 256 VLCKit.xcframework.zip | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          
          # æ‰“å°ä¸€ä¸‹æ–¹ä¾¿è°ƒè¯•
          echo "SHA256: $CHECKSUM"

      # ðŸ‘‡ ä¿®å¤é‡ç‚¹ 2ï¼šåœ¨å‘ç‰ˆå‰æ›´æ–° Package.swift å¹¶æäº¤
      - name: Update Package.swift
        run: |
          TAG="${{ needs.check-update.outputs.new_tag }}"
          CHECKSUM="${{ steps.package.outputs.checksum }}"
          REPO="https://github.com/${{ github.repository }}"
          URL="$REPO/releases/download/$TAG/VLCKit.xcframework.zip"
          
          echo "ðŸ“ æ­£åœ¨æ›´æ–° Package.swift..."
          
          # å†™å…¥æ–°çš„ Package.swift å†…å®¹
          cat > Package.swift <<EOF
          // swift-tools-version:5.9
          import PackageDescription

          let package = Package(
              name: "VLCKit",
              platforms: [
                  .iOS(.v12),
                  .tvOS(.v12),
                  .macOS(.v10_13)
              ],
              products: [
                  .library(
                      name: "VLCKit",
                      targets: ["VLCKit"]
                  ),
              ],
              targets: [
                  .binaryTarget(
                      name: "VLCKit",
                      url: "$URL",
                      checksum: "$CHECKSUM"
                  )
              ]
          )
          EOF
          
          # éªŒè¯å†…å®¹
          cat Package.swift

      # æäº¤ä»£ç å¹¶æ‰“ Tag
      - name: Commit & Tag
        run: |
          TAG="${{ needs.check-update.outputs.new_tag }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Package.swift
          git commit -m "ðŸ¤– Update VLCKit to $TAG" || echo "No changes to commit"
          
          echo "ðŸ·ï¸ æ‰“æ ‡ç­¾: $TAG"
          git tag "$TAG"
          
          echo "â¬†ï¸ æŽ¨é€ä»£ç å’Œæ ‡ç­¾..."
          git push origin main
          git push origin "$TAG"

      # åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-update.outputs.new_tag }}
          name: VLCKit ${{ needs.check-update.outputs.new_tag }}
          body: |
            Automatic build from upstream [${{ env.UPSTREAM_REPO }}](${{ needs.check-update.outputs.new_tag }}).
            
            ### Install via Swift Package Manager
            
            \`\`\`swift
            .package(url: "https://github.com/${{ github.repository }}", from: "${{ needs.check-update.outputs.new_tag }}")
            \`\`\`
            
            **Checksum:** \`${{ steps.package.outputs.checksum }}\`
          files: VLCKit.xcframework.zip
          draft: false
          prerelease: false

      # ðŸ‘‡ ä¿®å¤é‡ç‚¹ 3ï¼šå»¶é•¿ä¿ç•™æ—¶é—´ä¸º 5 å¤©ï¼Œæ–¹ä¾¿è°ƒè¯•ä¸‹è½½
      - name: Upload Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: VLCKit-${{ needs.check-update.outputs.new_tag }}
          path: VLCKit.xcframework.zip
          retention-days: 5

      # æ¸…ç†æ—§ Release (å¯é€‰)
      - name: Cleanup Old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: ${{ env.KEEP_RELEASES }}
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¤±è´¥é€šçŸ¥
  notify-failure:
    name: Notify Failure
    needs: build-and-release
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ Build Failed: ${{ needs.check-update.outputs.new_tag }}',
              body: 'Check actions log: ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            });
