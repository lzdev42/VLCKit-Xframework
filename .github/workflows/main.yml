name: Auto Build VLCKit Universal

on:
  # æ¯å¤© UTC 00:00 æ£€æŸ¥æ›´æ–°
  schedule:
    - cron: '0 0 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:

env:
  UPSTREAM_REPO: 'videolan/vlckit'
  KEEP_RELEASES: 5  # ä¿ç•™æœ€è¿‘ N ä¸ª Release

jobs:
  check-update:
    name: Check for New Tags
    runs-on: ubuntu-latest
    outputs:
      has_new_tag: ${{ steps.check.outputs.has_new_tag }}
      new_tag: ${{ steps.check.outputs.new_tag }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Check for new tags
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° tag
          LATEST_TAG=$(git ls-remote --tags --refs https://github.com/${{ env.UPSTREAM_REPO }}.git | 
                       grep -v '\^{}' | 
                       sort -t '/' -k 3 -V | 
                       tail -n1 | 
                       awk '{print $2}' | 
                       sed 's|refs/tags/||')
          
          echo "ä¸Šæ¸¸æœ€æ–° tag: $LATEST_TAG"
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨è¯¥ tag
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "Tag $LATEST_TAG å·²å­˜åœ¨ï¼Œæ— éœ€æ„å»º"
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–° tag: $LATEST_TAG"
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Universal XCFramework
    needs: check-update
    if: needs.check-update.outputs.has_new_tag == 'true'
    runs-on: macos-latest  # ä½¿ç”¨ M1 runnerï¼ˆæ›´å¿«ï¼‰
    timeout-minutes: 540  # 9 å°æ—¶è¶…æ—¶ï¼ˆç¼–è¯‘ä¸‰ä¸ªå¹³å°ï¼‰
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'
      
      - name: Show System Info
        run: |
          echo "=== System Info ==="
          sw_vers
          xcodebuild -version
          df -h
          sysctl -n hw.ncpu

      - name: Free up disk space and Verify Version
        run: |
          echo "--- æ¸…ç†å‰ ---"
          echo "ğŸ“Š ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo ""
          echo "ğŸ å·²å®‰è£…çš„ Xcode ç‰ˆæœ¬:"
          ls -ld /Applications/Xcode_*.app
          
          echo -e "\n--- å¼€å§‹æ¸…ç† (ä½¿ç”¨ç®€å•å¾ªç¯æ–¹æ³•) ---"

          # 1. æ˜ç¡®æ£€æµ‹å‡ºå½“å‰é€‰ä¸­çš„ Xcode è·¯å¾„
          SELECTED_XCODE_PATH=$(xcode-select -p | sed 's|/Contents/Developer||')
          if [[ -z "$SELECTED_XCODE_PATH" || ! -d "$SELECTED_XCODE_PATH" ]]; then
            echo "âŒ æ— æ³•ç¡®å®šå½“å‰ä½¿ç”¨çš„ Xcode è·¯å¾„ï¼Œä¸­æ­¢æ¸…ç†ä»¥ç­–å®‰å…¨ã€‚"
            exit 1
          fi
          echo "âœ… å¿…é¡»ä¿ç•™çš„ Xcode App è·¯å¾„: ${SELECTED_XCODE_PATH}"
          
          # 2. éå†æ‰€æœ‰ Xcodeï¼Œä¸æ˜¯é€‰ä¸­çš„è·¯å¾„å°±åˆ é™¤
          for XCODE_APP_PATH in /Applications/Xcode_*.app; do
            # æ£€æŸ¥è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªå®é™…å­˜åœ¨çš„ç›®å½•
            if [ -d "$XCODE_APP_PATH" ]; then
              if [ "$XCODE_APP_PATH" == "$SELECTED_XCODE_PATH" ]; then
                echo " L ä¿ç•™: $(basename $XCODE_APP_PATH)"
              else
                echo " X åˆ é™¤: $(basename $XCODE_APP_PATH)"
                sudo rm -rf "$XCODE_APP_PATH"
              fi
            fi
          done
          
          # 3. æ¸…ç† Xcode ç¼–è¯‘ç¼“å­˜
          sudo rm -rf ~/Library/Developer/Xcode/DerivedData/* 2>/dev/null || true
          
          echo "âœ… æ¸…ç†å®Œæˆã€‚"

          echo -e "\n--- æ¸…ç†å ---"
          echo "ğŸ“Š ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo ""
          echo "ğŸ æ£€æŸ¥å”¯ä¸€ä¿ç•™çš„ Xcode App:"
          ls -ld /Applications/Xcode_*.app
          echo ""

          # æœ€ç»ˆéªŒè¯ï¼šæ˜ç¡®æ˜¾ç¤ºä¿ç•™çš„ Xcode ç‰ˆæœ¬ä¿¡æ¯
          echo "âœ… æœ€ç»ˆéªŒè¯ï¼šç¡®è®¤ä¿ç•™çš„ Xcode ç‰ˆæœ¬..."
          if [[ -d "$SELECTED_XCODE_PATH" ]]; then
            echo "----------------------------------------"
            xcodebuild -version
            echo "----------------------------------------"
            echo "âœ… éªŒè¯æˆåŠŸï¼ä¸Šè¿°ç‰ˆæœ¬å·²è¢«æ­£ç¡®ä¿ç•™ã€‚"
          else
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šå½“å‰ä½¿ç”¨çš„ Xcode è¢«æ„å¤–åˆ é™¤ï¼"
            exit 1
          fi
      
      - name: Clone VLCKit
        run: |
          git clone --depth 1 --branch ${{ needs.check-update.outputs.new_tag }} \
            https://github.com/${{ env.UPSTREAM_REPO }}.git vlckit
          cd vlckit
          echo "âœ… å…‹éš†å®Œæˆï¼Œtag: ${{ needs.check-update.outputs.new_tag }}"

      - name: Install All Dependencies and Fix PATH
        run: |
          echo "--- å‡†å¤‡å®‰è£…æ‰€æœ‰ç¼–è¯‘ä¾èµ– ---"
          
          # 1. å®‰è£…æ‰€æœ‰ç¼ºå¤±çš„å·¥å…· (åŸºäºæ—¥å¿—çš„å®Œæ•´åˆ—è¡¨)
          # -----------------------------------------------------------------
          # autoconf, automake, libtool, pkg-config, cmake, gettext, bison, yasm, nasm, ragel (æ¥è‡ªä¹‹å‰ç‰ˆæœ¬)
          # ant, xz, meson, ninja, help2man (æ–°å¢çš„ã€ä¹‹å‰é—æ¼çš„åŒ…)
          # -----------------------------------------------------------------
          echo "STEP 1: å¼€å§‹å®‰è£…å®Œæ•´çš„å·¥å…·åŒ…..."
          brew install autoconf automake libtool pkg-config cmake ant xz gettext bison yasm nasm ragel meson ninja help2man
          
          echo "---"
          echo "STEP 2: å¤„ç†ç‰¹æ®ŠåŒ…çš„é“¾æ¥é—®é¢˜ (è§£å†³ incompatible version)..."
          # macOS è‡ªå¸¦äº†æ—§ç‰ˆçš„ bison å’Œ gettextï¼Œå¼ºåˆ¶è®©æ–°ç‰ˆç”Ÿæ•ˆ
          brew link --force bison
          brew link --force gettext
          
          echo "---"
          echo "STEP 3: ä¿®æ­£ PATH æœç´¢è·¯å¾„ (è§£å†³ not found)..."
          # å°† Homebrew è·¯å¾„æ·»åŠ åˆ°åç»­æ‰€æœ‰æ­¥éª¤çš„ PATH ç¯å¢ƒå˜é‡çš„æœ€å‰é¢
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          
          echo ""
          echo "âœ… æ‰€æœ‰ä¾èµ–å’Œè·¯å¾„é—®é¢˜å·²å…¨éƒ¨è§£å†³ã€‚"
          echo "---"
          echo "æœ€ç»ˆéªŒè¯ï¼šæ£€æŸ¥å…³é”®å·¥å…·çš„è·¯å¾„å’Œç‰ˆæœ¬..."
          
          echo -n "autoconf:  " && which autoconf && autoconf --version | head -n 1
          echo -n "automake:  " && which automake && automake --version | head -n 1
          echo -n "bison:     " && which bison && bison --version | head -n 1
          echo -n "cmake:     " && which cmake && cmake --version | head -n 1
          echo -n "meson:     " && which meson && meson --version | head -n 1
          echo -n "ninja:     " && which ninja && ninja --version | head -n 1
      
      - name: Build iOS XCFramework
        run: |
          cd vlckit
          
          echo "ğŸš€ [1/3] å¼€å§‹ç¼–è¯‘ iOSï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰"
          echo "åŒ…å«: iPhone/iPad çœŸæœº (arm64) + æ¨¡æ‹Ÿå™¨ (arm64/x86_64)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          ./compileAndBuildVLCKit.sh -f -r -a all
          
          echo "âœ… iOS ç¼–è¯‘å®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date)"
          ls -lh build/iOS/VLCKit.xcframework
      
      - name: Build tvOS XCFramework
        run: |
          cd vlckit
          
          echo "ğŸš€ [2/3] å¼€å§‹ç¼–è¯‘ tvOSï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰"
          echo "åŒ…å«: Apple TV çœŸæœº (arm64) + æ¨¡æ‹Ÿå™¨ (arm64/x86_64)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          ./compileAndBuildVLCKit.sh -f -r -a all -t
          
          echo "âœ… tvOS ç¼–è¯‘å®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date)"
          ls -lh build/tvOS/VLCKit.xcframework
      
      - name: Build macOS XCFramework
        run: |
          cd vlckit
          
          echo "ğŸš€ [3/3] å¼€å§‹ç¼–è¯‘ macOSï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰"
          echo "åŒ…å«: Apple Silicon (arm64) + Intel (x86_64)"
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          ./compileAndBuildVLCKit.sh -f -r -a all -x
          
          echo "âœ… macOS ç¼–è¯‘å®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date)"
          ls -lh build/macOS/VLCKit.xcframework
      
      - name: Merge into Universal XCFramework
        run: |
          cd vlckit/build
          
          echo "ğŸ”¨ å¼€å§‹åˆå¹¶æ‰€æœ‰å¹³å°åˆ°ä¸€ä¸ª Universal XCFramework..."
          
          # æå–æ‰€æœ‰å¹³å°çš„ framework è·¯å¾„
          IOS_FRAMEWORKS=""
          TVOS_FRAMEWORKS=""
          MACOS_FRAMEWORKS=""
          
          # iOS
          if [ -d "iOS/VLCKit.xcframework" ]; then
            for platform_dir in iOS/VLCKit.xcframework/*; do
              if [ -d "$platform_dir/VLCKit.framework" ]; then
                IOS_FRAMEWORKS="$IOS_FRAMEWORKS -framework $platform_dir/VLCKit.framework"
                echo "æ‰¾åˆ° iOS framework: $platform_dir"
              fi
            done
          fi
          
          # tvOS
          if [ -d "tvOS/VLCKit.xcframework" ]; then
            for platform_dir in tvOS/VLCKit.xcframework/*; do
              if [ -d "$platform_dir/VLCKit.framework" ]; then
                TVOS_FRAMEWORKS="$TVOS_FRAMEWORKS -framework $platform_dir/VLCKit.framework"
                echo "æ‰¾åˆ° tvOS framework: $platform_dir"
              fi
            done
          fi
          
          # macOS
          if [ -d "macOS/VLCKit.xcframework" ]; then
            for platform_dir in macOS/VLCKit.xcframework/*; do
              if [ -d "$platform_dir/VLCKit.framework" ]; then
                MACOS_FRAMEWORKS="$MACOS_FRAMEWORKS -framework $platform_dir/VLCKit.framework"
                echo "æ‰¾åˆ° macOS framework: $platform_dir"
              fi
            done
          fi
          
          # åˆå¹¶åˆ›å»º Universal XCFramework
          xcodebuild -create-xcframework \
            $IOS_FRAMEWORKS \
            $TVOS_FRAMEWORKS \
            $MACOS_FRAMEWORKS \
            -output VLCKit-Universal.xcframework
          
          echo "âœ… Universal XCFramework åˆ›å»ºæˆåŠŸ"
          ls -lh VLCKit-Universal.xcframework
          
          # æ˜¾ç¤ºåŒ…å«çš„å¹³å°
          echo ""
          echo "ğŸ“¦ åŒ…å«çš„å¹³å°ï¼š"
          ls -1 VLCKit-Universal.xcframework/
      
      - name: Compress with Maximum Level
        run: |
          cd vlckit/build
          
          echo "ğŸ“¦ å¼€å§‹å‹ç¼©ï¼ˆæœ€é«˜çº§åˆ« -9ï¼Œè¿™å¯èƒ½éœ€è¦ 30-60 åˆ†é’Ÿï¼‰..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # ä½¿ç”¨æœ€é«˜å‹ç¼©çº§åˆ«
          zip -9 -r VLCKit.xcframework.zip VLCKit-Universal.xcframework
          
          echo "âœ… å‹ç¼©å®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date)"
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ï¼š"
          ls -lh VLCKit.xcframework.zip
          du -sh VLCKit-Universal.xcframework
      
      - name: Calculate Checksum
        id: checksum
        run: |
          cd vlckit/build
          
          # è®¡ç®— SHA256
          CHECKSUM=$(shasum -a 256 VLCKit.xcframework.zip | awk '{print $1}')
          echo "$CHECKSUM  VLCKit.xcframework.zip" > checksum.txt
          
          echo "âœ… æ ¡éªŒå’Œï¼š"
          cat checksum.txt
          
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: VLCKit-${{ needs.check-update.outputs.new_tag }}
          path: |
            vlckit/build/VLCKit.xcframework.zip
            vlckit/build/checksum.txt
          retention-days: 1
          compression-level: 0  # å·²ç»å‹ç¼©è¿‡äº†ï¼Œä¸éœ€è¦å†å‹ç¼©

  release:
    name: Create GitHub Release
    needs: [check-update, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download Artifact
        uses: actions/download-artifact@v6
        with:
          name: VLCKit-${{ needs.check-update.outputs.new_tag }}
          path: ./artifacts
      
      - name: Read Checksum
        id: checksum
        run: |
          CHECKSUM=$(cat ./artifacts/checksum.txt | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ SHA256 Checksum:"
          cat ./artifacts/checksum.txt
      
      - name: Get File Size
        id: filesize
        run: |
          SIZE=$(ls -lh ./artifacts/VLCKit.xcframework.zip | awk '{print $5}')
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $SIZE"
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-update.outputs.new_tag }}
          name: VLCKit ${{ needs.check-update.outputs.new_tag }}
          body: |
            ## ğŸ‰ VLCKit ${{ needs.check-update.outputs.new_tag }} - Universal XCFramework
            
            > è‡ªåŠ¨ç¼–è¯‘è‡ª [videolan/vlckit@${{ needs.check-update.outputs.new_tag }}](https://github.com/${{ env.UPSTREAM_REPO }}/tree/${{ needs.check-update.outputs.new_tag }})
            
            ---
            
            ### ğŸ“¦ åŒ…å«å¹³å°
            
            æ­¤ç‰ˆæœ¬åŒ…å«ä¸€ä¸ª **Universal XCFramework**ï¼Œæ”¯æŒä¸»æµ Apple å¹³å°ï¼š
            
            | å¹³å° | æ¶æ„ | è¯´æ˜ |
            |------|------|------|
            | **iOS** | arm64 | iPhone/iPad çœŸæœº |
            | **iOS Simulator** | arm64, x86_64 | M1/M2 Mac & Intel Mac |
            | **tvOS** | arm64 | Apple TV çœŸæœº |
            | **tvOS Simulator** | arm64, x86_64 | M1/M2 Mac & Intel Mac |
            | **macOS** | arm64, x86_64 | Apple Silicon & Intel Mac |
            
            > ğŸ’¡ **å…³äºå…¶ä»–å¹³å°ï¼š**
            > - **visionOS**: Vision Pro å¯åœ¨å…¼å®¹æ¨¡å¼ä¸‹è¿è¡Œ iOS ç‰ˆæœ¬
            > - **watchOS**: æ‰‹è¡¨ä¸é€‚åˆæ’­æ”¾è§†é¢‘ï¼Œå·²æ’é™¤
            
            ### ğŸ“Š æ–‡ä»¶ä¿¡æ¯
            
            - **æ–‡ä»¶å**: `VLCKit.xcframework.zip`
            - **å¤§å°**: `${{ steps.filesize.outputs.size }}`
            - **å‹ç¼©çº§åˆ«**: æœ€é«˜ï¼ˆ-9ï¼‰
            
            ### ğŸ” æ ¡éªŒå’Œ
            
            ```
            SHA256: ${{ steps.checksum.outputs.checksum }}
            ```
            
            éªŒè¯ä¸‹è½½ï¼š
            ```bash
            shasum -a 256 VLCKit.xcframework.zip
            ```
            
            ---
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            
            #### æ–¹å¼ 1: Swift Package Manager (æ¨è)
            
            åœ¨ `Package.swift` ä¸­æ·»åŠ ï¼š
            
            ```swift
            dependencies: [
                .package(url: "https://github.com/${{ github.repository }}", from: "${{ needs.check-update.outputs.new_tag }}")
            ]
            ```
            
            æˆ–åœ¨ Xcode ä¸­ï¼š
            1. `File` â†’ `Add Package Dependencies...`
            2. è¾“å…¥ï¼š`https://github.com/${{ github.repository }}`
            3. é€‰æ‹©ç‰ˆæœ¬åç‚¹å‡» `Add Package`
            
            #### æ–¹å¼ 2: æ‰‹åŠ¨é›†æˆ
            
            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.check-update.outputs.new_tag }}/VLCKit.xcframework.zip
            
            # éªŒè¯
            echo "${{ steps.checksum.outputs.checksum }}  VLCKit.xcframework.zip" | shasum -a 256 -c
            
            # è§£å‹
            unzip VLCKit.xcframework.zip
            
            # æ‹–å…¥ Xcode é¡¹ç›®
            ```
            
            #### æ–¹å¼ 3: CocoaPods
            
            ```ruby
            pod 'VLCKit', :http => 'https://github.com/${{ github.repository }}/releases/download/${{ needs.check-update.outputs.new_tag }}/VLCKit.xcframework.zip'
            ```
            
            ---
            
            ### ğŸ’¡ è·¨å¹³å°å¼€å‘ç¤ºä¾‹
            
            æ­¤ Universal XCFramework å®Œç¾æ”¯æŒè·¨å¹³å°å¼€å‘ï¼š
            
            ```swift
            import SwiftUI
            import VLCKit
            
            struct VideoPlayer: View {
                var body: some View {
                    // åŒä¸€å¥—ä»£ç ï¼ŒiOS/tvOS/macOS é€šç”¨
                    VLCPlayerView()
                        #if os(iOS)
                        .navigationBarTitleDisplayMode(.inline)
                        #endif
                }
            }
            ```
            
            ç¼–è¯‘æ—¶ Xcode ä¼šè‡ªåŠ¨é€‰æ‹©å¯¹åº”å¹³å°çš„ä»£ç ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼
            
            ---
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            æŸ¥çœ‹ä¸Šæ¸¸æ›´æ–°ï¼š[VLCKit Releases](https://github.com/${{ env.UPSTREAM_REPO }}/releases)
            
            ---
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            
            - VLCKit ç›¸å…³é—®é¢˜ï¼š[videolan/vlckit Issues](https://github.com/${{ env.UPSTREAM_REPO }}/issues)
            - æ„å»ºè„šæœ¬é—®é¢˜ï¼š[æœ¬ä»“åº“ Issues](https://github.com/${{ github.repository }}/issues)
            
            ---
            
            ### ğŸ“œ è®¸å¯è¯
            
            VLCKit é‡‡ç”¨ **LGPL v2.1** æˆ–æ›´é«˜ç‰ˆæœ¬
            
            ---
            
            ğŸ¤– **æœ¬ç‰ˆæœ¬ç”± GitHub Actions å…¨è‡ªåŠ¨æ„å»º**  
            ğŸ’¤ ç¡ä¸€è§‰ï¼Œæ–°ç‰ˆæœ¬å°±ç¼–è¯‘å¥½äº†ï¼
          draft: false
          prerelease: false
          files: |
            ./artifacts/VLCKit.xcframework.zip
            ./artifacts/checksum.txt
      
      - name: Update Package.swift
        run: |
          TAG="${{ needs.check-update.outputs.new_tag }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          REPO="${{ github.repository }}"
          
          cat > Package.swift << 'EOF'
          // swift-tools-version:5.9
          import PackageDescription
          
          let package = Package(
              name: "VLCKit",
              platforms: [
                  .iOS(.v12),
                  .tvOS(.v12),
                  .macOS(.v10_13)
              ],
              products: [
                  .library(
                      name: "VLCKit",
                      targets: ["VLCKit"]
                  )
              ],
              targets: [
                  .binaryTarget(
                      name: "VLCKit",
                      url: "https://github.com/REPO_PLACEHOLDER/releases/download/TAG_PLACEHOLDER/VLCKit.xcframework.zip",
                      checksum: "CHECKSUM_PLACEHOLDER"
                  )
              ]
          )
          EOF
          
          # æ›¿æ¢å ä½ç¬¦
          sed -i "s|REPO_PLACEHOLDER|${REPO}|g" Package.swift
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" Package.swift
          sed -i "s|CHECKSUM_PLACEHOLDER|${CHECKSUM}|g" Package.swift
          
          echo "âœ… Package.swift å·²æ›´æ–°"
          cat Package.swift
      
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Package.swift
          git commit -m "ğŸ¤– Update to VLCKit ${{ needs.check-update.outputs.new_tag }}"
          git push
      
      - name: Cleanup Old Releases
        uses: actions/github-script@v8
        with:
          script: |
            const repo = context.repo;
            const keepCount = ${{ env.KEEP_RELEASES }};
            
            console.log(`ğŸ“‹ æ¸…ç†ç­–ç•¥: ä¿ç•™æœ€è¿‘ ${keepCount} ä¸ªç‰ˆæœ¬`);
            
            // è·å–æ‰€æœ‰ releases
            const { data: releases } = await github.rest.repos.listReleases({
              owner: repo.owner,
              repo: repo.repo,
              per_page: 100
            });
            
            console.log(`ğŸ“Š å½“å‰å…±æœ‰ ${releases.length} ä¸ª releases`);
            
            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedReleases = releases.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );
            
            // åˆ é™¤æ—§ç‰ˆæœ¬
            if (sortedReleases.length > keepCount) {
              const toDelete = sortedReleases.slice(keepCount);
              
              console.log(`ğŸ—‘ï¸  å°†åˆ é™¤ ${toDelete.length} ä¸ªæ—§ç‰ˆæœ¬`);
              
              for (const release of toDelete) {
                console.log(`   - åˆ é™¤: ${release.tag_name} (${release.created_at})`);
                
                // åˆ é™¤ release
                await github.rest.repos.deleteRelease({
                  owner: repo.owner,
                  repo: repo.repo,
                  release_id: release.id
                });
                
                // åˆ é™¤å¯¹åº”çš„ tag
                try {
                  await github.rest.git.deleteRef({
                    owner: repo.owner,
                    repo: repo.repo,
                    ref: `tags/${release.tag_name}`
                  });
                } catch (error) {
                  console.log(`   âš ï¸  Tag ${release.tag_name} åˆ é™¤å¤±è´¥æˆ–å·²åˆ é™¤`);
                }
              }
              
              console.log(`âœ… æ¸…ç†å®Œæˆï¼ä¿ç•™äº†æœ€è¿‘ ${keepCount} ä¸ªç‰ˆæœ¬`);
            } else {
              console.log(`âœ… å½“å‰ç‰ˆæœ¬æ•° (${sortedReleases.length}) â‰¤ ä¿ç•™æ•° (${keepCount})ï¼Œæ— éœ€æ¸…ç†`);
            }

  notify:
    name: Notify on Failure
    needs: [check-update, build, release]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.check-update.outputs.new_tag }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'build-failure',
              per_page: 100
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes(tag)
            );
            
            if (existingIssue) {
              // æ›´æ–°ç°æœ‰ issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ å†æ¬¡æ„å»ºå¤±è´¥\n\n- **è¿è¡Œæ—¶é—´**: ${new Date().toISOString()}\n- **è¿è¡Œæ—¥å¿—**: ${runUrl}\n\nè¯·æ£€æŸ¥æ—¥å¿—ä»¥äº†è§£è¯¦æƒ…ã€‚`
              });
            } else {
              // åˆ›å»ºæ–° issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ VLCKit ${tag} æ„å»ºå¤±è´¥`,
                body: `## æ„å»ºå¤±è´¥
                
                - **Tag**: ${tag}
                - **è¿è¡Œæ—¥å¿—**: ${runUrl}
                - **æ—¶é—´**: ${new Date().toISOString()}
                
                ### å¯èƒ½çš„åŸå› 
                
                1. ç¼–è¯‘è¶…æ—¶ï¼ˆ> 10 å°æ—¶ï¼‰
                2. ç£ç›˜ç©ºé—´ä¸è¶³
                3. ä¸Šæ¸¸ä»£ç å˜æ›´å¯¼è‡´ç¼–è¯‘å¤±è´¥
                4. GitHub Actions ç¯å¢ƒé—®é¢˜
                
                è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥äº†è§£è¯¦æƒ…ã€‚`,
                labels: ['build-failure', 'automated']
              });
            }
